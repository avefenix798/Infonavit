USE [CRTSA]
GO

/****** Object:  View [dbo].[V_CARTERA_OFICIAL_DW]    Script Date: 05/21/2015 09:17:00 ******/
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[V_CARTERA_OFICIAL_DW]'))
DROP VIEW [dbo].[V_CARTERA_OFICIAL_DW]
GO

USE [CRTSA]
GO

/****** Object:  View [dbo].[V_CARTERA_OFICIAL_DW]    Script Date: 05/21/2015 09:17:00 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [dbo].[V_CARTERA_OFICIAL_DW] AS
SELECT 
		 FH_CORTE AS FH_CORTE
		,C.FH_INFORMACION AS FH_INFORMACION
		,FH_AFIRMATIVA_FICTA AS FH_AFIRMATIVA_FICTA
		,FH_CANCELACION_REESTRUCTURA AS FH_CANCELACION_REESTRUCTURA
		,FH_CAMBIO_CARTERA_VENCIDA AS FH_CAMBIO_CARTERA_VENCIDA
		,FH_OTORGAMIENTO AS FH_OTORGAMIENTO
		,FH_REESTRUCTURA AS FH_REESTRUCTURA
		,FH_RELACION_LABORAL AS FH_RELACION_LABORAL
		,FH_ULTIMA_ACTUALIZACION AS FH_ULTIMA_ACTUALIZACION
		,FH_ULTIMA_PRORROGA AS FH_ULTIMA_PRORROGA
		,FH_ULTIMO_PAGO AS FH_ULTIMO_PAGO
		,FH_ULTIMO_PAGO_NO_RECIBIDO AS FH_ULTIMO_PAGO_NO_RECIBIDO
		,FH_VENCIMIENTO AS FH_VENCIMIENTO
		,FH_VIGENCIA_SPP AS FH_VIGENCIA_SPP
		,CV_CLASIFICACION_PRODUCTO_POA AS CV_CLASIFICACION_PRODUCTO_POA
		,CV_CONTABLE AS CV_CONTABLE
		,CV_CREDITO AS CV_CREDITO
		,CV_CREDITO_PREFIJO AS CV_CREDITO_PREFIJO
		,CV_ENTIDAD_FEDERATIVA AS CV_ENTIDAD_FEDERATIVA
		,CV_ESTATUS_CONTABLE AS CV_ESTATUS_CONTABLE
		,CV_ESTATUS_CREDITO		AS CV_ESTATUS_CREDITO
		,CV_ESTATUS_REESTRUCTURA AS CV_ESTATUS_REESTRUCTURA
		,CV_LINEA AS CV_LINEA
		,CV_MONEDA AS CV_MONEDA
		,CV_MUNICIPIO AS CV_MUNICIPIO
		,CV_NRP AS CV_NRP
		,CV_NSS AS CV_NSS
		,CV_NSS_PREFIJO AS CV_NSS_PREFIJO
		,CV_OFERENTE AS CV_OFERENTE
		,CV_PAQUETE AS CV_PAQUETE
		,CV_PLAZO AS CV_PLAZO
		--,CAST(CASE WHEN CV_POOL = '' THEN '999' 
		--           ELSE ISNULL(CV_POOL,'999') 
		--      END AS CHAR(3))								AS CV_POOL
		,CV_POOL AS CV_POOL
		,CV_POOL_BURSATILIZADO AS CV_POOL_BURSATILIZADO
		--,CAST(CASE WHEN CV_POOL_SALDOS = '' THEN '9999' 
		--           ELSE ISNULL(CV_POOL_SALDOS,'9999') 
		--      END AS CHAR(4))								AS CV_POOL_SALDOS
		,CV_POOL_SALDOS		AS CV_POOL_SALDOS
		--,CAST(CASE WHEN CV_PRODUCTO_CREDITO = '' THEN '9999' 
		--           ELSE ISNULL(CV_PRODUCTO_CREDITO,'9999') 
		--       END AS CHAR(4))								AS CV_PRODUCTO_CREDITO
		,CV_PRODUCTO_CREDITO	AS CV_PRODUCTO_CREDITO
		,CV_PRODUCTO_REESTRUCTURA AS CV_PRODUCTO_REESTRUCTURA
		,CV_PROGRAMA				AS CV_PROGRAMA
		,CASE 
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  0		AND  0.99 THEN 'A'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  1		AND  1.99 THEN 'B'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  2		AND  2.99 THEN 'C'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  3		AND  3.99 THEN 'D'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  4		AND  4.40 THEN 'E'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  4.41   AND  4.99 THEN 'F'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  5		AND  5.99 THEN 'G'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  6		AND  6.99 THEN 'H'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  7		AND  7.99 THEN 'I'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  8		AND  8.99 THEN 'J'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN  9		AND  9.99 THEN 'K'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN 10		AND 10.99 THEN 'L'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) BETWEEN 11		AND 14.99 THEN 'M'
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO/B.SALARIO_MINIMO_DIARIO),1) >=      15			      THEN 'N'
		 ELSE '999' END																									AS CV_RANGO_SALARIAL		
		--,CAST(CASE WHEN CV_REGIMEN = '' THEN '999' 
		--           ELSE ISNULL (CV_REGIMEN,'999') 
		--       END AS CHAR(3))						AS CV_REGIMEN
		,CV_REGIMEN				AS CV_REGIMEN
		--,CAST(CASE WHEN CV_REGLA_CREDITO = '' THEN '99' 
		--           ELSE ISNULL (CV_REGLA_CREDITO,'99') 
		--       END AS CHAR(2))						AS CV_REGLA_CREDITO
		,CV_REGLA_CREDITO		AS CV_REGLA_CREDITO
		--,CAST(CASE WHEN CV_SEGMENTO_CARTERA='' THEN '9999'
		--           ELSE ISNULL (CV_SEGMENTO_CARTERA,'9999') 
		--       END AS CHAR(2))						 AS CV_SEGMENTO_CARTERA
		,CV_SEGMENTO_CARTERA		AS CV_SEGMENTO_CARTERA
		--,CAST(CASE WHEN CV_SITUACION_CREDITO='' THEN '99'
		--           ELSE ISNULL (CV_SITUACION_CREDITO,'99')  
		--       END AS CHAR(2))						AS CV_SITUACION_CREDITO
		,CV_SITUACION_CREDITO			AS CV_SITUACION_CREDITO
		--,CAST(CASE WHEN CV_SPP IN ('','   - 0    ') THEN '9999999999'
		--		   ELSE ISNULL (CV_SPP,'9999999999') 
		--       END AS CHAR(10))						AS CV_SPP
		,CV_SPP							AS CV_SPP
		--,CAST(CASE WHEN CV_TIPO_PAGO='' THEN '9'
		--           ELSE ISNULL (CV_TIPO_PAGO,'9')
		--       END AS CHAR(1))						AS CV_TIPO_PAGO
		,CV_TIPO_PAGO					AS CV_TIPO_PAGO
		,CV_TIPO_PRORROGA AS CV_TIPO_PRORROGA
		,CV_TIPO_TASA AS CV_TIPO_TASA
		,ID_COFINANCIADO AS ID_COFINANCIADO
		,CASE WHEN IM_PESOS_SALARIO_INTEGRADO = 0 THEN 999
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) BETWEEN -0.25 AND -0.01  THEN -1
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) BETWEEN -0.50 AND -0.26  THEN -2
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) BETWEEN -0.75 AND -0.51  THEN -3
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) BETWEEN -0.99 AND -0.76  THEN -4
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) = 00.00	              THEN  0
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) BETWEEN 00.01 AND 00.25  THEN  1
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) BETWEEN 00.26 AND 00.50  THEN  2
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) BETWEEN 00.51 AND 00.75  THEN  3
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) BETWEEN 00.76 AND 01.00  THEN  4
			  WHEN ROUND((IM_PESOS_SALARIO_DIARIO_INTEGRADO-IM_PESOS_SALARIO_INTEGRADO)/IM_PESOS_SALARIO_INTEGRADO,2) > 01.00                  THEN  5
			ELSE 999 END								AS ID_COMPORTAMIENTO_INGRESO		
		,CASE WHEN ISNULL(NU_OMISOS,0) = 0 THEN 1
			  WHEN NU_OMISOS = 1 THEN 2
			  WHEN NU_OMISOS = 2 THEN 3
			  WHEN NU_OMISOS = 3 THEN 4
			  WHEN NU_OMISOS = 4 THEN 5
			  WHEN NU_OMISOS = 5 THEN 6
			  WHEN NU_OMISOS = 6 THEN 7
			  WHEN NU_OMISOS = 7 THEN 8
			  WHEN NU_OMISOS = 8 THEN 9
			  WHEN NU_OMISOS = 9 THEN 10
			  WHEN NU_OMISOS = 10 THEN 11
			  WHEN NU_OMISOS = 11 THEN 12
			  WHEN NU_OMISOS = 12 THEN 13
			  WHEN NU_OMISOS BETWEEN 13 AND 15 THEN 14
			  WHEN NU_OMISOS BETWEEN 16 AND 18 THEN 15
			  WHEN NU_OMISOS BETWEEN 19 AND 24 THEN 16
			  WHEN NU_OMISOS BETWEEN 25 AND 36 THEN 17
			  WHEN NU_OMISOS > 36 THEN 18
		 END											AS ID_RANGO_PAGOS_OMISOS
		,IN_AFIRMATIVA_FICTA AS IN_AFIRMATIVA_FICTA
		,CAST(CASE WHEN CV_CREDITO_CONYUGAL  IN (' ','00000000000000000000000000') THEN 0 
		           ELSE 1 
		      END AS INT)								AS IN_CREDITO_CONYUGAL
		,IN_CREDITO_PARTICIPADO AS IN_CREDITO_PARTICIPADO
		,IN_CURA_REESTRUCTURA AS IN_CURA_REESTRUCTURA
		,IN_INTERES_ACREDITADO AS IN_INTERES_ACREDITADO
		,IN_INTERES_ORIGINACION AS IN_INTERES_ORIGINACION
		,IN_PRORROGA_PROMOCIONAL AS IN_PRORROGA_PROMOCIONAL
		,IN_PRORROGA_VIGENTE AS IN_PRORROGA_VIGENTE
		,CAST(CASE WHEN DATEDIFF(MM,FH_RELACION_LABORAL,GETDATE()) >= 4 
		                AND NU_OMISOS=0 AND CV_REGIMEN = 'REA' THEN 1 
                   ELSE 0 
               END AS INT)									AS IN_REA_SUPERIOR_4_MESES
		,IN_REESTRUCTURA AS IN_REESTRUCTURA
		,IN_RELACION_LABORAL AS IN_RELACION_LABORAL
		,IN_SUBSIDIO AS IN_SUBSIDIO
		,IN_VIVIENDA_NUEVA AS IN_VIVIENDA_NUEVA
		,IN_VIVIENDA_USADA AS IN_VIVIENDA_USADA
		,IN_VIVIENDA_ECOLOGICA AS IN_VIVIENDA_ECOLOGICA
		,IN_VIVIENDA_SUSTENTABLE AS IN_VIVIENDA_SUSTENTABLE
		,IN_VIVIENDA_VERTICAL AS IN_VIVIENDA_VERTICAL
		,PC_PARTICIPACION AS PC_PARTICIPACION
		,PC_QUITA AS PC_QUITA
		,PC_REESTRUCTURA_ACREDITADO AS PC_REESTRUCTURA_ACREDITADO
		,TS_INTERES_ACREDITADO AS TS_INTERES_ACREDITADO
		,TS_INTERES_ORIGINAL  AS TS_INTERES_ORIGINAL
		,NU_AÑO_EJERCICIO			AS NU_AÑO_EJERCICIO
		,NU_DIAS_MORA_VENCIDOS AS NU_DIAS_MORA_VENCIDOS
		,NU_OMISOS AS NU_OMISOS
		,NU_OMISOS_REESTRUCTURADOS AS NU_OMISOS_REESTRUCTURADOS
		,NU_PAGOS_REMANENTES AS NU_PAGOS_REMANENTES
		,NU_PRORROGAS_MOROSIDAD AS NU_PRORROGAS_MOROSIDAD
		,NU_PRORROGAS_PROMOCIONALES AS NU_PRORROGAS_PROMOCIONALES
		,CT_FACTOR_REA AS CT_FACTOR_REA
		,CT_FACTOR_ROA AS CT_FACTOR_ROA
		,CT_VSM_CAPITAL_CUENTA_PROBLEMA_118C1 AS CT_VSM_CAPITAL_CUENTA_PROBLEMA_118C1
		,CT_VSM_CAPITAL_PARTICIPADO_810 AS CT_VSM_CAPITAL_PARTICIPADO_810
		,CT_VSM_COMISION_CONVENIO_JUDICIAL_303 AS CT_VSM_COMISION_CONVENIO_JUDICIAL_303
		,CT_VSM_COMISION_CONVENIO_PRIVADO_302 AS CT_VSM_COMISION_CONVENIO_PRIVADO_302
		,CT_VSM_FACTOR_PAGO_REA_ORIGINACION AS CT_VSM_FACTOR_PAGO_REA_ORIGINACION
		,CT_VSM_FACTOR_PAGO_ROA_ORIGINACION AS CT_VSM_FACTOR_PAGO_ROA_ORIGINACION
		,CT_VSM_INTERES_COMPLEMENTARIO_PARTICIPADO_828 AS CT_VSM_INTERES_COMPLEMENTARIO_PARTICIPADO_828
		,CT_VSM_MONTO_ORIGINACION_CREDITO AS CT_VSM_MONTO_ORIGINACION_CREDITO
		,CT_VSM_SEGURO_DAÑOS_301 AS CT_VSM_SEGURO_DAÑOS_301
		,CT_VSM_ULTIMO_PAGO_RECIBIDO AS CT_VSM_ULTIMO_PAGO_RECIBIDO
		,CT_VSM_FONDO_PROTECCION_PAGOS_304 AS CT_VSM_FONDO_PROTECCION_PAGOS_304
		--,IM_BENEFICIO_ENTIDADES_FINANCIERAS AS IM_BENEFICIO_ENTIDADES_FINANCIERAS
		--,IM_BENEFICIO_INFONAVIT AS IM_BENEFICIO_INFONAVIT
		,IM_CAPITAL_PESOS AS IM_CAPITAL_PESOS
		,IM_CAPITAL_REESTRUCTURADO_OFICIAL_PESOS AS IM_CAPITAL_REESTRUCTURADO_OFICIAL_PESOS
		,IM_CAPITAL_REESTRUCTURADO_OFICIAL_VSM AS IM_CAPITAL_REESTRUCTURADO_OFICIAL_VSM
		,IM_CAPITAL_VSM AS IM_CAPITAL_VSM
		,IM_INTERES_COMPLEMENTARIO_PESOS AS IM_INTERES_COMPLEMENTARIO_PESOS
		,IM_INTERES_COMPLEMENTARIO_VSM AS IM_INTERES_COMPLEMENTARIO_VSM
		,IM_INTERES_PESOS AS IM_INTERES_PESOS
		,IM_INTERES_VSM AS IM_INTERES_VSM
		,IM_MONTO_ORIGINACION_CREDITO AS IM_MONTO_ORIGINACION_CREDITO
		,IM_NETO_CREDITO AS IM_NETO_CREDITO
		,IM_PAGO_ESPERADO AS IM_PAGO_ESPERADO
		,IM_PESOS_CAPITAL_CUENTA_PROBLEMA_118C1 AS IM_PESOS_CAPITAL_CUENTA_PROBLEMA_118C1
		,IM_PESOS_CAPITAL_PARTICIPADO_810 AS IM_PESOS_CAPITAL_PARTICIPADO_810
		,IM_PESOS_CAPITAL_REESTRUCTURADO AS IM_PESOS_CAPITAL_REESTRUCTURADO
		,IM_PESOS_COMISION_CONVENIO_JUDICIAL_303 AS IM_PESOS_COMISION_CONVENIO_JUDICIAL_303
		,IM_PESOS_COMISION_CONVENIO_PRIVADO_302 AS IM_PESOS_COMISION_CONVENIO_PRIVADO_302
		,IM_PESOS_FONDO_PROTECCION_PAGOS_304 AS IM_PESOS_FONDO_PROTECCION_PAGOS_304
		,IM_PESOS_INTERES_COMPLEMENTARIO_PARTICIPADO_828 AS IM_PESOS_INTERES_COMPLEMENTARIO_PARTICIPADO_828
		,IM_PESOS_INTERES_TOTAL_ACUMULADO AS IM_PESOS_INTERES_TOTAL_ACUMULADO
		,IM_PESOS_SALARIO_DIARIO_INTEGRADO AS IM_PESOS_SALARIO_DIARIO_INTEGRADO
		,IM_PESOS_SALDO_INTERES AS IM_PESOS_SALDO_INTERES
		,IM_PESOS_SEGURO_DAÑOS_301 AS IM_PESOS_SEGURO_DAÑOS_301
		,IM_SALARIO_SUBCUENTA_97 AS IM_SALARIO_SUBCUENTA_97
		,IM_SALDO_INTERES_CONDONADO AS IM_SALDO_INTERES_CONDONADO
		,IM_SALDO_REMANENTE AS IM_SALDO_REMANENTE
		,IM_SALDO_TOTAL_PESOS AS IM_SALDO_TOTAL_PESOS
		,IM_SALDO_TOTAL_VSM AS IM_SALDO_TOTAL_VSM
		,CV_SITUACION_ESTATUS  AS   CV_SITUACION_ESTATUS
		,ID_PARCIALMENTE_EJERCIDO  AS  ID_PARCIALMENTE_EJERCIDO
		,TX_CODIGO_REGISTRO   AS  TX_CODIGO_REGISTRO
		,PC_INCREMENTO_ANUAL  AS  PC_INCREMENTO_ANUAL
		,CT_FACTOR_REA_CONTRACTUAL  AS  CT_FACTOR_REA_CONTRACTUAL
		,CT_FACTOR_ROA_CONTRACTUAL  AS  CT_FACTOR_ROA_CONTRACTUAL
		,CT_FACTOR_REA_CONVENIDO  AS  CT_FACTOR_REA_CONVENIDO
		,CT_FACTOR_ROA_CONVENIDO  AS  CT_FACTOR_ROA_CONVENIDO	
FROM CRTSA.dbo.CARTERA_OFICIAL															A
LEFT JOIN CRTDW.dbo.V_SALARIO_MINIMO_DF_ACTUAL											B
		 ON                    1 = 1
LEFT JOIN (SELECT MAX(FH_INFORMACION) AS FH_INFORMACION FROM CRTDW.dbo.FECHA_CARGA WHERE IN_CIERRE_MES=1) C
		 ON                    1 = 1




GO


