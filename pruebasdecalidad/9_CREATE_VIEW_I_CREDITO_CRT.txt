USE [CRTDW]
GO

/****** Object:  View [dbo].[I_CREDITO_CRT]    Script Date: 05/21/2015 00:11:30 ******/
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[I_CREDITO_CRT]'))
DROP VIEW [dbo].[I_CREDITO_CRT]
GO

USE [CRTDW]
GO

/****** Object:  View [dbo].[I_CREDITO_CRT]    Script Date: 05/21/2015 00:11:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [dbo].[I_CREDITO_CRT]
--WITH SCHEMABINDING
AS

SELECT 
		 E.CV_CREDITO							AS CV_CREDITO
		,E.CV_CLASIFICACION_PRODUCTO_POA		AS CV_CLASIFICACION_PRODUCTO_POA
		,E.CV_ESTATUS_CREDITO					AS CV_ESTATUS_CREDITO
		,E.CV_MUNICIPIO_CREDITO					AS CV_MUNICIPIO_CREDITO
		,E.CV_NSS								AS CV_NSS
		,E.CV_ENTIDAD_FEDERATIVA_EJERCICIO		AS CV_ENTIDAD_FEDERATIVA_EJERCICIO
		,ISNULL(P.CV_OFERENTE,'')				AS CV_OFERENTE
		,ISNULL(E.CV_PAQUETE,'')				AS CV_PAQUETE
		,ISNULL(E.CV_PROGRAMA,'')				AS CV_PROGRAMA
		,E.FH_ULTIMA_ACTUALIZACION				AS FH_ULTIMA_ACTUALIZACION
		,F.IN_SUBSIDIO							AS IN_SUBSIDIO
		,ISNULL(E.IN_VIVIENDA_NUEVA,'9')		AS IN_VIVIENDA_NUEVA
		,ISNULL(CASE 
				WHEN E.IN_VIVIENDA_NUEVA=0 THEN 1
				ELSE 0
				END,
		        '9')							AS IN_VIVIENDA_USADA
		,ISNULL(E.IN_VIVIENDA_ECOLOGICA,'9')	AS IN_VIVIENDA_ECOLOGICA
		,ISNULL(E.IN_VIVIENDA_SUSTENTABLE,'9')	AS IN_VIVIENDA_SUSTENTABLE
		,ISNULL(E.IN_VIVIENDA_VERTICAL,'9')		AS IN_VIVIENDA_VERTICAL
		,ISNULL(E.NU_AÑO_EJERCICIO,0)			AS NU_AÑO_EJERCICIO
		,ISNULL(E.IM_NETO_CREDITO,0)			AS IM_NETO_CREDITO
		,ISNULL(D.IM_SALARIO_INTEGRADO,0)		AS IM_SALARIO_INTEGRADO
		,ISNULL(R.IM_SALARIO_SUBCUENTA_97,0)	AS IM_SALARIO_SUBCUENTA_97
		,ISNULL(E.IM_SALDO_SUBCUENTA,0)			AS IM_SALDO_SUBCUENTA

FROM
	(SELECT *
	 FROM CREDW.dbo.DEMANDA_DWH						A
	 WHERE		CV_CLASIFICACION_PRODUCTO_POA = 'RTH'
			AND CV_CREDITO IS NOT NULL
	 UNION ALL
	 SELECT *
	 FROM CREDW.dbo.DEMANDA_DWH						B
	 WHERE CV_CREDITO NOT IN
							(SELECT DISTINCT CV_CREDITO
							 FROM CREDW.dbo.DEMANDA_DWH
							 WHERE CV_CLASIFICACION_PRODUCTO_POA = 'RTH') 
		AND CV_CREDITO IS NOT NULL
	)												E
LEFT JOIN 
   	(SELECT * FROM  CREDW.dbo.CREDITO_RCL_PRD WHERE CV_CREDITO<>'0000000000')		F
ON		 (F.CV_CREDITO = E.CV_CREDITO )
 LEFT JOIN CREDW.dbo.M_SOLICITUD_RTH						R
ON       (F.CV_CREDITO = R.CV_CREDITO)
 LEFT JOIN  CREDW.dbo.M_PAQUETE							P
ON       (E.CV_PAQUETE=P.CV_PAQUETE)
 LEFT JOIN  dbo.M_DERECHOHABIENTE					D
 ON F.CV_NSS=D.CV_NSS
 --WHERE F.CV_CREDITO<>'0000000000'

GO


